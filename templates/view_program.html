{% extends "base.html" %}

{% block title %}{{ program.name }} - Project Manager{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('programs') }}">Programs</a></li>
                <li class="breadcrumb-item active">{{ program.name }}</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row mb-4">
    <div class="col">
        <div class="d-flex justify-content-between align-items-center">
            <h1><i class="bi bi-folder"></i> {{ program.name }}</h1>
            <div>
                <a href="{{ url_for('edit_program', program_id=program.id) }}" class="btn btn-warning">
                    <i class="bi bi-pencil"></i> Edit
                </a>
                <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                    <i class="bi bi-trash"></i> Delete
                </button>
            </div>
        </div>
        <p class="text-muted">{{ program.description }}</p>
        <div class="mb-3">
            <span class="badge bg-secondary">{{ program.status }}</span>
            {% if program.start_date %}<span class="badge bg-info">Start: {{ program.start_date }}</span>{% endif %}
            {% if program.end_date %}<span class="badge bg-warning">End: {{ program.end_date }}</span>{% endif %}
        </div>
    </div>
</div>

<!-- Tabs -->
<ul class="nav nav-tabs mb-3" role="tablist">
    <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="tab" href="#projects">Projects ({{ program.projects|length }})</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#milestones">Milestones ({{ program.milestones|length }})</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#materials">Materials ({{ program.materials|length }})</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#team">Team ({{ program.assigned_contacts|length }})</a>
    </li>
</ul>

<div class="tab-content">
    <!-- Projects Tab -->
    <div class="tab-pane fade show active" id="projects">
        <div class="mb-3">
            <a href="{{ url_for('new_project') }}?program_id={{ program.id }}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Add Project
            </a>
        </div>
        
        {% if program.projects %}
        <div class="row">
            {% for project in program.projects %}
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <a href="{{ url_for('view_project', project_id=project.id) }}">{{ project.name }}</a>
                        </h5>
                        <p class="card-text">{{ project.description[:100] if project.description else 'No description' }}</p>
                        <div class="mb-2">
                            <span class="badge bg-secondary">{{ project.status }}</span>
                            <span class="badge bg-info">{{ project.tasks|length }} tasks</span>
                        </div>
                        <small class="text-muted">
                            {% if project.start_date %}{{ project.start_date }}{% endif %}
                            {% if project.end_date %} - {{ project.end_date }}{% endif %}
                        </small>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-muted">No projects yet. Add one to get started!</p>
        {% endif %}
    </div>

    <!-- Milestones Tab -->
    <div class="tab-pane fade" id="milestones">
        <div class="mb-3">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#milestoneModal">
                <i class="bi bi-plus-circle"></i> Add Milestone
            </button>
        </div>
        
        {% if program.milestones %}
        <div class="list-group">
            {% for milestone in program.milestones|sort(attribute='target_date') %}
            <div class="list-group-item">
                <div class="d-flex w-100 justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-1">
                            {% if milestone.achieved %}
                            <i class="bi bi-check-circle-fill text-success"></i>
                            {% else %}
                            <i class="bi bi-circle text-muted"></i>
                            {% endif %}
                            {{ milestone.name }}
                        </h5>
                        <p class="mb-1">{{ milestone.description }}</p>
                        <small class="text-muted">Target: {{ milestone.target_date }}</small>
                        {% if milestone.achieved %}
                        <small class="text-success"> | Achieved: {{ milestone.achieved_date }}</small>
                        {% endif %}
                    </div>
                    <div>
                        <form method="POST" action="{{ url_for('toggle_milestone', milestone_id=milestone.id) }}" style="display: inline;">
                            <button type="submit" class="btn btn-sm btn-outline-success">
                                <i class="bi bi-check"></i>
                            </button>
                        </form>
                        <form method="POST" action="{{ url_for('delete_milestone', milestone_id=milestone.id) }}" style="display: inline;">
                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-muted">No milestones yet. Add one to track important dates!</p>
        {% endif %}
    </div>

    <!-- Materials Tab -->
    <div class="tab-pane fade" id="materials">
        <div class="mb-3">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#materialModal">
                <i class="bi bi-plus-circle"></i> Add Material
            </button>
        </div>
        
        {% if program.materials %}
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Quantity</th>
                        <th>Unit</th>
                        <th>Cost/Unit</th>
                        <th>Total</th>
                        <th>Supplier</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for material in program.materials %}
                    <tr>
                        <td>{{ material.name }}</td>
                        <td>{{ material.description }}</td>
                        <td>{{ material.quantity }}</td>
                        <td>{{ material.unit }}</td>
                        <td>${{ "%.2f"|format(material.cost_per_unit) if material.cost_per_unit else 'N/A' }}</td>
                        <td>${{ "%.2f"|format(material.total_cost) }}</td>
                        <td>{{ material.supplier or 'N/A' }}</td>
                        <td>
                            <form method="POST" action="{{ url_for('delete_material', material_id=material.id) }}" style="display: inline;">
                                <button type="submit" class="btn btn-sm btn-danger">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-muted">No materials yet. Add materials needed for this program!</p>
        {% endif %}
    </div>

    <!-- Team Tab -->
    <div class="tab-pane fade" id="team">
        <div class="mb-3">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#assignModal">
                <i class="bi bi-plus-circle"></i> Assign Contact
            </button>
        </div>
        
        {% if program.assigned_contacts %}
        <div class="row">
            {% for contact in program.assigned_contacts %}
            <div class="col-md-4 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">{{ contact.name }}</h5>
                        <p class="card-text">
                            <small class="text-muted">{{ contact.role or 'No role specified' }}</small><br>
                            {% if contact.email %}<i class="bi bi-envelope"></i> {{ contact.email }}<br>{% endif %}
                            {% if contact.phone %}<i class="bi bi-phone"></i> {{ contact.phone }}{% endif %}
                        </p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-muted">No team members assigned yet.</p>
        {% endif %}
    </div>
</div>

<!-- Delete Program Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Program</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this program? This will also delete all associated projects, tasks, materials, and milestones.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" action="{{ url_for('delete_program', program_id=program.id) }}">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Add Milestone Modal -->
<div class="modal fade" id="milestoneModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('new_program_milestone', program_id=program.id) }}">
                <div class="modal-header">
                    <h5 class="modal-title">Add Milestone</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="name" class="form-label">Name</label>
                        <input type="text" class="form-control" id="name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="target_date" class="form-label">Target Date</label>
                        <input type="date" class="form-control" id="target_date" name="target_date" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Milestone</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Material Modal -->
<div class="modal fade" id="materialModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('new_program_material', program_id=program.id) }}">
                <div class="modal-header">
                    <h5 class="modal-title">Add Material</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="name" class="form-label">Name</label>
                        <input type="text" class="form-control" id="name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="2"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="quantity" class="form-label">Quantity</label>
                            <input type="number" step="0.01" class="form-control" id="quantity" name="quantity" value="1" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="unit" class="form-label">Unit</label>
                            <input type="text" class="form-control" id="unit" name="unit" placeholder="e.g., units, kg, hours">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="cost_per_unit" class="form-label">Cost per Unit ($)</label>
                        <input type="number" step="0.01" class="form-control" id="cost_per_unit" name="cost_per_unit">
                    </div>
                    <div class="mb-3">
                        <label for="supplier" class="form-label">Supplier</label>
                        <input type="text" class="form-control" id="supplier" name="supplier">
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Material</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Assign Contact Modal -->
<div class="modal fade" id="assignModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('assign_to_program', program_id=program.id) }}">
                <div class="modal-header">
                    <h5 class="modal-title">Assign Contact</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="contact_id" class="form-label">Select Contact</label>
                        <select class="form-select" id="contact_id" name="contact_id" required>
                            <option value="">Choose a contact...</option>
                            {% for contact in all_contacts %}
                            <option value="{{ contact.id }}">{{ contact.name }} - {{ contact.role or 'No role' }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% if not all_contacts %}
                    <p class="text-muted">No contacts available. <a href="{{ url_for('new_contact') }}">Create one first</a>.</p>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" {% if not all_contacts %}disabled{% endif %}>Assign</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// AJAX for milestone toggle
document.querySelectorAll('form[action*="toggle_milestone"]').forEach(form => {
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        fetch(this.action, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            location.reload();
        });
    });
});
</script>
{% endblock %}
